---
phase: 01-foundation-validation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - validator.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Validator returns errors for missing x402Version field"
    - "Validator returns errors for invalid or missing payments array"
    - "Validator returns errors for payments missing required fields (chain, address, asset, minAmount)"
    - "Validator returns errors for unknown chains"
    - "Validator returns errors for invalid EVM addresses (wrong length, bad checksum)"
    - "Validator returns errors for invalid Solana addresses (bad Base58, wrong byte length)"
    - "Validator returns errors for invalid chain/asset combinations"
    - "Validator returns errors for non-positive minAmount"
    - "Validator returns warnings for optional field issues (HTTP facilitator, maxAmount < minAmount)"
    - "Validator distinguishes errors from warnings in output structure"
  artifacts:
    - path: "validator.js"
      provides: "Complete x402 config validation engine"
      exports: ["validateX402Config"]
      min_lines: 150
    - path: "index.html"
      provides: "Test interface for validation"
      contains: "textarea"
  key_links:
    - from: "validator.js"
      to: "chains.js"
      via: "function calls"
      pattern: "isEVMChain|isSolanaChain|isValidAssetForChain"
    - from: "validator.js"
      to: "ethers"
      via: "EVM address validation"
      pattern: "ethers\\.utils\\.getAddress"
    - from: "validator.js"
      to: "bs58"
      via: "Solana address validation"
      pattern: "bs58\\.decode"
---

<objective>
Build the complete x402 config validation engine

Purpose: Implement all VAL-01 through VAL-10 requirements. This is the core logic that validates x402 payment configs, checking structure, field presence, address formats, chain/asset combinations, and optional fields. Output uses the error format from CONTEXT.md with field paths and fix suggestions.

Output: validator.js with complete validation logic, index.html updated with test textarea to exercise the validator
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-validation/01-CONTEXT.md
@.planning/phases/01-foundation-validation/01-RESEARCH.md
@.planning/phases/01-foundation-validation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create complete validation engine</name>
  <files>validator.js</files>
  <action>
Create validator.js implementing all validation requirements. Follow the layered validation pattern from RESEARCH.md.

**Main function: `validateX402Config(configText)`**

Returns object:
```javascript
{
  valid: boolean,      // true if no errors (warnings OK)
  version: number,     // detected x402 version (1 or 2)
  errors: Array,       // blocking issues
  warnings: Array      // advisory issues
}
```

Each error/warning follows format from CONTEXT.md:
```javascript
{
  field: 'payments[0].address',  // field path
  message: '"0x123" is not valid',  // what's wrong
  fix: 'EVM addresses are 42 characters (0x + 40 hex)'  // how to fix
}
```

**Validation layers (in order):**

1. **JSON Parse** (VAL-01 partial)
   - Try JSON.parse, catch syntax errors
   - Error: field 'root', message describes parse error location

2. **Version Check** (VAL-01)
   - Check x402Version exists
   - Check x402Version is 1 or 2
   - Error if missing or invalid

3. **Payments Array** (VAL-02)
   - v1: check `payments` field
   - v2: check `accepts` field
   - Must be non-empty array
   - Error if missing or empty

4. **Payment Entry Validation** (VAL-03, VAL-04, VAL-05, VAL-06, VAL-07, VAL-08)
   For each payment entry:

   a. Required fields check (VAL-03):
      - v1: chain, address, asset, minAmount
      - v2: chain/network, payTo, asset, price/minAmount

   b. Chain validation (VAL-04):
      - Use `isKnownChain()` from chains.js
      - Error if not in: base, base-sepolia, solana, solana-devnet

   c. Address validation (VAL-05, VAL-06):
      - If EVM chain: use `ethers.utils.getAddress()` for checksum validation
        - Accept all-lowercase as valid
        - Error on invalid format
        - Error on bad checksum for mixed-case
      - If Solana chain: use `bs58.decode()` + check 32-byte length
        - Error on invalid Base58
        - Error on wrong byte length
      - Cross-check: EVM address on Solana chain = error (and vice versa)

   d. Asset validation (VAL-07):
      - Use `isValidAssetForChain()` from chains.js
      - Error if asset not valid for chain type

   e. Amount validation (VAL-08):
      - minAmount (v1) or price (v2) must be positive
      - Parse as number, check > 0
      - Reject scientific notation
      - Error if not positive decimal

5. **Optional Fields** (VAL-09)
   - facilitator.url: if present, warn if not HTTPS
   - maxAmount: if present, error if < minAmount
   - description, resource: no validation needed (just note their presence)

6. **Error vs Warning Separation** (VAL-10)
   - Errors: missing required fields, invalid formats, semantic violations
   - Warnings: HTTP urls, missing optional fields, deprecated patterns
   - valid = true if errors.length === 0 (warnings don't block)

**Helper functions to implement:**
- `validateEvmAddress(address, fieldPath)` - returns {errors, warnings}
- `validateSolanaAddress(address, fieldPath)` - returns {errors, warnings}
- `validatePositiveDecimal(value, fieldPath)` - returns {errors}
- `validateFacilitator(facilitator, fieldPath)` - returns {warnings}
- `getJsonErrorLocation(error)` - extract line/column from parse error

Use patterns from RESEARCH.md code examples for address validation. Include checksum suggestion in EVM error messages when applicable.
  </action>
  <verify>
Test validation function in browser console with test cases:

```javascript
// Test 1: Valid v1 config
validateX402Config(JSON.stringify({
  x402Version: 1,
  payments: [{
    chain: 'base',
    address: '0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045',
    asset: 'USDC',
    minAmount: '1.00'
  }]
}));
// Expected: valid: true, errors: []

// Test 2: Missing version
validateX402Config(JSON.stringify({ payments: [] }));
// Expected: valid: false, errors include x402Version error

// Test 3: Invalid EVM address
validateX402Config(JSON.stringify({
  x402Version: 1,
  payments: [{
    chain: 'base',
    address: '0x123',
    asset: 'USDC',
    minAmount: '1.00'
  }]
}));
// Expected: valid: false, error about address

// Test 4: Solana address on EVM chain
validateX402Config(JSON.stringify({
  x402Version: 1,
  payments: [{
    chain: 'base',
    address: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    asset: 'USDC',
    minAmount: '1.00'
  }]
}));
// Expected: valid: false, error about address format mismatch

// Test 5: Invalid asset for chain
validateX402Config(JSON.stringify({
  x402Version: 1,
  payments: [{
    chain: 'solana',
    address: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    asset: 'ETH',
    minAmount: '1.00'
  }]
}));
// Expected: valid: false, error about ETH not valid for Solana
```
  </verify>
  <done>Validation engine correctly handles all test cases with proper error/warning structure</done>
</task>

<task type="auto">
  <name>Task 2: Add test interface to HTML</name>
  <files>index.html</files>
  <action>
Update index.html to add a minimal test interface for the validation engine:

1. Add a textarea (id="config-input") for pasting JSON config
   - Placeholder text: "Paste your x402 config JSON here..."
   - Reasonable size (e.g., 80 cols, 20 rows)

2. Add a "Validate" button (id="validate-btn")

3. Add a results div (id="results") to display validation output

4. Add inline script (or in separate ui.js) that:
   - On button click, gets textarea value
   - Calls validateX402Config()
   - Displays results in results div
   - Shows valid/invalid status
   - Lists errors with field paths and fix suggestions
   - Lists warnings separately

5. Basic styling (inline or style tag):
   - Errors in red
   - Warnings in orange/yellow
   - Valid status in green
   - Monospace font for JSON/field paths

This is a minimal test harness, not the final UI. Purpose is to exercise the validator during development. Phase 3 will build the polished results display.

Note: Add validator.js script tag if not already present.
  </action>
  <verify>
1. Open index.html in browser
2. Paste valid config into textarea:
   ```json
   {
     "x402Version": 1,
     "payments": [{
       "chain": "base",
       "address": "0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045",
       "asset": "USDC",
       "minAmount": "1.00"
     }]
   }
   ```
3. Click Validate button
4. Should see green "Valid" status
5. Paste invalid config (e.g., missing chain field)
6. Click Validate
7. Should see red "Invalid" status with specific error about missing chain field
  </verify>
  <done>Test interface allows pasting JSON and displays validation results with errors/warnings</done>
</task>

</tasks>

<verification>
Run through comprehensive validation test suite:

**Schema validation:**
- [ ] Missing x402Version returns error
- [ ] x402Version: 3 returns error
- [ ] Missing payments array returns error
- [ ] Empty payments array returns error
- [ ] Payment missing chain returns error
- [ ] Payment missing address returns error
- [ ] Payment missing asset returns error
- [ ] Payment missing minAmount returns error

**Chain validation:**
- [ ] chain: 'base' passes
- [ ] chain: 'ethereum' returns error (unknown chain)

**Address validation:**
- [ ] Valid checksummed EVM address passes
- [ ] All-lowercase EVM address passes (valid)
- [ ] Invalid checksum EVM address returns error with suggestion
- [ ] Too-short EVM address returns error
- [ ] Valid Solana address passes
- [ ] Invalid Base58 Solana address returns error
- [ ] EVM address on Solana chain returns error
- [ ] Solana address on EVM chain returns error

**Asset validation:**
- [ ] USDC on base passes
- [ ] ETH on base passes
- [ ] SOL on base returns error
- [ ] USDC on solana passes
- [ ] SOL on solana passes
- [ ] ETH on solana returns error

**Amount validation:**
- [ ] "1.00" passes
- [ ] 1 passes (number type)
- [ ] "0" returns error
- [ ] "-5" returns error
- [ ] "1e10" returns error

**Optional fields:**
- [ ] facilitator.url with HTTPS passes (no warning)
- [ ] facilitator.url with HTTP returns warning
- [ ] maxAmount >= minAmount passes
- [ ] maxAmount < minAmount returns error

**Error format:**
- [ ] Errors include field path
- [ ] Errors include fix suggestion
- [ ] Warnings are separate from errors
- [ ] valid: true when only warnings present
</verification>

<success_criteria>
- validateX402Config function exists and is callable
- All VAL-01 through VAL-10 requirements implemented
- Error messages follow CONTEXT.md format (field path, message, fix)
- Errors and warnings are properly separated
- Test interface displays validation results
- Valid configs show green status
- Invalid configs show red status with specific errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-validation/01-02-SUMMARY.md`
</output>
